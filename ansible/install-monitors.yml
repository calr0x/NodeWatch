---

# This is a collection of monitors to check various states at regular scheduled intervals.
# Monitors performed:
#  Check for bids every hour
#  Check docker container "otnode" is running every 5 minutes

# Settings to edit:
# All "bidcheck_" entries
# All "dockercheck_" entries

####################################################################
# This script will:
# 1. Delete existing OT-NodeWatch directory
# 2. Clone git.
# 3. Copy edited config.
# 4. Delete any existing cron jobs for bid_watch/docker_watch.
# 5. Add cron jobs for both with current configured values.
# 6. Stop Cosmic_Overlay ping script if running.

- name: Install Monitors
  hosts: all
  vars:
    bidcheck_minute: '0' # Checks every hour
    bidcheck_hour: '*'
    bidcheck_day: '*'
    bidcheck_month: '*'
    bidcheck_weekday: '*'
    dockercheck_minute: '*/5' # Checks every 5 minutes
    dockercheck_hour: '*'
    dockercheck_day: '*'
    dockercheck_month: '*'
    dockercheck_weekday: '*'
  gather_facts: no

  tasks:
    - name: Delete existing OT-NodeWatch folder
      file:
        path: /root/OT-NodeWatch
        state: absent

    - name: Delete existing OT-Settings folder
      file:
        path: /root/OT-Settings
        state: absent

    - name: Clone OT-NodeWatch git repository
      git:
        repo: 'https://github.com/calr0x/OT-NodeWatch.git'
        dest: /root/OT-NodeWatch
        force: yes

    - name: Clone OT-Settings git repository
      git:
        repo: 'https://github.com/calr0x/OT-Settings.git'
        dest: /root/OT-Settings
        force: yes

    - name: Copy config file
      copy:
        src: /root/OT-Settings/config.sh
        dest: /root/OT-Settings

    - name: Delete existing monitor (bid check) schedule from cron
      cron:
        name: Monitor Bid Check
        state: absent

    - name: Add monitor (bid check) schedule to cron (every hour)
      cron:
        name: Monitor Bid Check
        minute: "{{ bidcheck_minute }}"
        hour: "{{ bidcheck_hour }}"
        day: "{{ bidcheck_day }}"
        month: "{{ bidcheck_month }}"
        weekday: "{{ bidcheck_weekday }}"
        job: "/root/OT-NodeWatch/bid_check/bid_check.sh"

    - name: Delete existing monitor (docker check) schedule from cron
      cron:
        name: Monitor Docker Check
        state: absent

    - name: Add monitor (Docker check) schedule to cron (every 5 minutes)
      cron:
        name: Monitor Docker Check
        minute: "{{ dockercheck_minute }}"
        hour: "{{ dockercheck_hour }}"
        day: "{{ dockercheck_day }}"
        month: "{{ dockercheck_month }}"
        weekday: "{{ dockercheck_weekday }}"
        job: "/root/OT-NodeWatch/docker_check/docker_check.sh"

    - name: Stop Cosmic_Overlay ping script (if present)
      ignore_errors: yes
      command:
        chdir: /root/Cosmic_OverlayV2/cron-jobs-node
        cmd: forever stop ping.js
